name: Version Bump & Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
      prerelease:
        description: "Prerelease identifier (leave empty for stable release)"
        required: false
        type: string
        default: ""
      skip_pr:
        description: "Skip PR creation (directly commit and tag)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      branch_name: ${{ steps.bump.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(grep -m1 'version = ' Cargo.toml | cut -d'"' -f2)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          BUMP_TYPE="${{ github.event.inputs.bump_type }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"

          # Split version into parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT%%-*}"

          # Bump version
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          # Add prerelease suffix if specified
          if [ -n "$PRERELEASE" ]; then
            NEW_VERSION="$NEW_VERSION-$PRERELEASE"
          fi

          BRANCH_NAME="release/v$NEW_VERSION"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "üöÄ New version: $NEW_VERSION"

      - name: Update Cargo.toml
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.bump.outputs.new_version }}"/' Cargo.toml
          echo "üìù Updated Cargo.toml to version ${{ steps.bump.outputs.new_version }}"

      - name: Update Cargo.lock
        run: cargo update --workspace

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Direct commit and tag (skip PR)
        if: github.event.inputs.skip_pr == 'true'
        run: |
          git add Cargo.toml Cargo.lock
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git tag -a "v${{ steps.bump.outputs.new_version }}" -m "Release v${{ steps.bump.outputs.new_version }}"
          git push origin main --follow-tags

      - name: Create release branch
        if: github.event.inputs.skip_pr != 'true'
        run: |
          git checkout -b "${{ steps.bump.outputs.branch_name }}"
          git add Cargo.toml Cargo.lock
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git push origin "${{ steps.bump.outputs.branch_name }}"

      - name: Create Pull Request
        if: github.event.inputs.skip_pr != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.bump.outputs.branch_name }}
          base: main
          title: "üöÄ Release v${{ steps.bump.outputs.new_version }}"
          body: |
            ## Release v${{ steps.bump.outputs.new_version }}

            This PR bumps the version from `${{ steps.current.outputs.version }}` to `${{ steps.bump.outputs.new_version }}`.

            ### Changes
            - Updated `Cargo.toml` version
            - Updated `Cargo.lock`

            ### Release Process
            1. ‚úÖ Review this PR
            2. ‚úÖ Merge when ready
            3. üè∑Ô∏è After merge, create a tag `v${{ steps.bump.outputs.new_version }}` to trigger the release:
               ```bash
               git checkout main && git pull
               git tag -a v${{ steps.bump.outputs.new_version }} -m "Release v${{ steps.bump.outputs.new_version }}"
               git push origin v${{ steps.bump.outputs.new_version }}
               ```

            Or use the Release workflow with manual dispatch.
          labels: |
            release
            automated
          draft: false
